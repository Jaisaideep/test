WITH 
  DOMINO_AGG AS (
    SELECT 
      DATE(LogTime) as Logdate,
      AVG(WaitTime) AS AvgWaitTime,
      AVG(RequestTestResponseTime) AS AvgResponseTime,
      AVG(DocumentCompleteTime) AS AvgDocumentCompleteTime
    FROM `vz-it-pr-jabv-aidplt-0.AIDSRE.DOMINO_CP_DATA`
    GROUP BY DATE(LogTime)
  ),
  DATAROBOT_AGG AS (
    SELECT 
      DATE(LogTime) as Logdate,
      AVG(WaitTime) AS AvgWaitTime,
      AVG(RequestTestResponseTime) AS AvgResponseTime,
      AVG(DocumentCompleteTime) AS AvgDocumentCompleteTime
    FROM `vz-it-pr-jabv-aidplt-0.AIDSRE.DATAROBOT_CP_DATA`
    GROUP BY DATE(LogTime)
  ),
  UI_AGG AS (
    SELECT 
      DATE(day) as Logdate,
      AVG(dataproc) / 100 * 0.125 AS AvgDataproc,
      AVG(oozie) / 100 * 0.125 AS AvgOozie,
      AVG(yarn) / 100 * 0.125 AS AvgYarn,
      AVG(jupyter) / 100 * 0.125 AS AvgJupyter,
      AVG(jupyterlab) / 100 * 0.125 AS AvgJupyterLab,
      AVG(hive) / 100 * 0.125 AS AvgHive,
      AVG(sparkhs) / 100 * 0.125 AS AvgSparkhs,
      AVG(knox) / 100 * 0.125 AS AvgKnox
    FROM `vz-it-pr-jabv-aidplt-0.sre_dashboard.c_dataproc_ui_health`
    GROUP BY DATE(day)
  )
SELECT 
  DOM.Logdate,
  (CASE 
    WHEN DOM.AvgWaitTime < 800 THEN 1
    WHEN DOM.AvgWaitTime BETWEEN 800 AND 1000 THEN 0.95
    WHEN DOM.AvgWaitTime BETWEEN 1001 AND 1500 THEN 0.90
    ELSE 0.85 
  END) as DOMINO_WaitTime_Percentage,
  (CASE 
    WHEN DOM.AvgResponseTime < 1000 THEN 1
    WHEN DOM.AvgResponseTime BETWEEN 1000 AND 1500 THEN 0.95
    WHEN DOM.AvgResponseTime BETWEEN 1501 AND 2000 THEN 0.90
    ELSE 0.85
  END) as DOMINO_ResponseTime_Percent,
  (CASE
    WHEN DOM.AvgDocumentCompleteTime < 2500 THEN 1
    WHEN DOM.AvgDocumentCompleteTime BETWEEN 2500 AND 3000 THEN 0.95
    WHEN DOM.AvgDocumentCompleteTime BETWEEN 3001 AND 3500 THEN 0.90
    ELSE 0.85
  END) AS DOMINO_DocumentCompleteTime_Percentage,
  (CASE 
    WHEN DR.AvgWaitTime < 800 THEN 1
    WHEN DR.AvgWaitTime BETWEEN 800 AND 1000 THEN 0.95
    WHEN DR.AvgWaitTime BETWEEN 1001 AND 1500 THEN 0.90
    ELSE 0.85 
  END) as DATAROBOT_WaitTime_Percentage,
  (CASE 
    WHEN DR.AvgResponseTime < 1000 THEN 1
    WHEN DR.AvgResponseTime BETWEEN 1000 AND 1500 THEN 0.95
    WHEN DR.AvgResponseTime BETWEEN 1501 AND 2000 THEN 0.90
    ELSE 0.85
  END) as DATAROBOT_ResponseTime_Percent,
  (CASE
    WHEN DR.AvgDocumentCompleteTime < 2500 THEN 1
    WHEN DR.AvgDocumentCompleteTime BETWEEN 2500 AND 3000 THEN 0.95
    WHEN DR.AvgDocumentCompleteTime BETWEEN 3001 AND 3500 THEN 0.90
    ELSE 0.85
  END) AS DATAROBOT_DocumentCompleteTime_Percentage,
  (UI.AvgDataproc + UI.AvgOozie + UI.AvgYarn + UI.AvgJupyter + UI.AvgJupyterLab + UI.AvgHive + UI.AvgSparkhs + UI.AvgKnox) AS UI_Health
FROM DOMINO_AGG DOM
LEFT JOIN DATAROBOT_AGG DR ON DOM.Logdate = DR.Logdate
LEFT JOIN UI_AGG UI ON DOM.Logdate = UI.Logdate
ORDER BY DOM.Logdate DESC;