WITH aysInfo AS (
    SELECT c.incident_id,
           c.action,
           c.timestamp,
           c.ays_assigned_username,
           c.response_data -> 'incident' ->> 'assignment_group' AS ays_group,
           c.response_data -> 'incident' ->> 'number' AS ays_inc_number,
           c.response_data -> 'incident' ->> 'state' AS state,
           c.response_data -> 'incident' ->> 'caller_id' AS caller_id,
           c.response_data -> 'incident' ->> 'affected_user' AS affected_user,
           c.response_data -> 'incident' ->> 'configuration_item' AS configuration_item,
           c.response_data -> 'incident' ->> 'priority' AS priority,
           c.sent_data ->> 'resolution_code' AS resolution_code,
           c.sent_data ->> 'resolution_update' AS resolution_update,
           c.sent_data ->> 'short_description' AS short_description,
           nh.timestamp AS history_timestamp,
           nh.status,
           nh.tags_nr_vsad AS vsad,
           nam.app_name,
           nh.category,
           nh.group_name,
           nh.user_name,
           -- Alias the timestamps properly
           MIN(CASE WHEN c.action = 'OPEN_AYS' THEN c.timestamp END) OVER (PARTITION BY c.incident_id) AS open_ays_timestamp,
           MIN(CASE WHEN c.action IN ('ASSIGN_AYS','ASSIGN_GROUP','ASSIGN_TIER2','ESCALATE_TIER','CONVERT_TO_MIM') THEN c.timestamp END) OVER (PARTITION BY c.incident_id) AS assign_ays_submission,
           MAX(CASE WHEN c.action = 'CLOSE_AYS' THEN nh.timestamp END) OVER (PARTITION BY c.incident_id) AS close_ays_submission
    FROM datacollection.c_ops_ays_data c
    JOIN datacollection.newrelic_vsad_event_history nh ON c.incident_id = nh.root_inc_id
                                                         AND c.action = nh.status
    LEFT JOIN datacollection.nsit_apps_master nam ON nh.tags_nr_vsad = nam.vsad
),
Calculations AS (
    SELECT
        COUNT(DISTINCT ays_inc_number) AS "Overall ays tickets count",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (assign_ays_submission - open_ays_timestamp))/60 > 5 THEN 1 ELSE 0 END) AS "Ack > 5 min",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (assign_ays_submission - open_ays_timestamp))/60 < 5 THEN 1 ELSE 0 END) AS "Ack < 5 min",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (close_ays_submission - open_ays_timestamp))/60 > 20 THEN 1 ELSE 0 END) AS "Close > 20 min",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (close_ays_submission - open_ays_timestamp))/60 < 20 THEN 1 ELSE 0 END) AS "Close < 20 min",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (close_ays_submission - open_ays_timestamp))/60 > 60 THEN 1 ELSE 0 END) AS "Close > 60 min",
        SUM(CASE WHEN EXTRACT(EPOCH FROM (close_ays_submission - open_ays_timestamp))/60 < 60 THEN 1 ELSE 0 END) AS "Close < 60 min",
        COUNT(DISTINCT CASE WHEN action = 'ESCALATED_TIER' THEN ays_inc_number END) AS "Number of escalated tickets"
    FROM aysInfo
)
SELECT *
FROM Calculations;