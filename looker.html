Query One:

WITH ays_query AS (with aysInfo as(with ays as (
      select c.incident_id, c.action, c.timestamp, c.ays_assigned_username,
      c.response_data -> 'incident' ->> 'assignment_group' as ays_group,
      c.response_data -> 'incident' ->> 'number' as ays_inc_number,
      c.response_data -> 'incident' ->> 'state' as state,
      c.response_data -> 'incident' ->> 'caller_id' as caller_id,
      c.response_data -> 'incident' ->> 'affected_user' as affected_user,
      c.response_data -> 'incident' ->> 'configuration_item' as configuration_item,
      c.response_data -> 'incident' ->> 'priority' as priority,
      c.sent_data ->> 'resolution_code' as resolution_code,
      c.sent_data ->> 'resolution_update' as resolution_update,
      c.sent_data ->> 'short_description' as short_description,
        nh.timestamp as history_timestamp,nh.status ,nh.tags_nr_vsad as vsad,nam.app_name,
        nh.category,nh.group_name,nh.user_name
        from datacollection.c_ops_ays_data c
      join datacollection.newrelic_vsad_event_history nh on c.incident_id = nh.root_inc_id
        and c.action = nh.status
      left join datacollection.nsit_apps_master nam on nh.tags_nr_vsad = nam.vsad)
      select RN,incident_id,coalesce(ays_group,group_name) as ays_group,ays_inc_number,user_name,ays_assigned_username,action, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,min(openTimeStamp) over ( partition by incident_id) as open_ays_timestamp,
      min(assignTimestamp) over ( partition by incident_id) as assign_ays_submission,
      max(closeTimeStamp) over ( partition by incident_id) as close_ays_submission,vsad,coalesce(app_name,vsad) as app_name,aysTime,
              case when category='' then 'Not Mapped'
                else category
                end

               from (
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,timestamp openTimeStamp,null::timestamp without time zone assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='OPEN_AYS'
      union
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,timestamp assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action in('ASSIGN_AYS','ASSIGN_GROUP','ASSIGN_TIER2','ESCALATE_TIER','CONVERT_TO_MIM')
      union
      select ROW_NUMBER() OVER (PARTITION BY incident_id
      ORDER BY timestamp DESC) AS RN, incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, 'Resolved' as state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,null::timestamp without time zone assignTimestamp, history_timestamp closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='CLOSE_AYS'

      ) as t)
      SELECT * from aysInfo where RN=1
      order by vsad,incident_id,aystime )
SELECT
    CASE
  WHEN (((CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT))) >= 5) THEN 'Ack > 5'
  WHEN (((CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT))) < 5) THEN 'Ack < 5'
  ELSE 'Other'
END
 AS "ack_case",
    COUNT(DISTINCT ( ays_query."ays_inc_number"  ) ) AS "ays_query.incident_count"
FROM ays_query
WHERE (ays_query."action" ) = 'ESCALATE_TIER' AND ((CASE
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) >= 5) THEN 'Ack > 5'
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) < 5) THEN 'Ack < 5'
  ELSE 'Other'
END
) <> 'Other' OR (CASE
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) >= 5) THEN 'Ack > 5'
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) < 5) THEN 'Ack < 5'
  ELSE 'Other'
END
) IS NULL)
GROUP BY
    1
ORDER BY
    1
FETCH NEXT 500 ROWS ONLY

-- sql for creating the total and/or determining pivot columns
WITH ays_query AS (with aysInfo as(with ays as (
      select c.incident_id, c.action, c.timestamp, c.ays_assigned_username,
      c.response_data -> 'incident' ->> 'assignment_group' as ays_group,
      c.response_data -> 'incident' ->> 'number' as ays_inc_number,
      c.response_data -> 'incident' ->> 'state' as state,
      c.response_data -> 'incident' ->> 'caller_id' as caller_id,
      c.response_data -> 'incident' ->> 'affected_user' as affected_user,
      c.response_data -> 'incident' ->> 'configuration_item' as configuration_item,
      c.response_data -> 'incident' ->> 'priority' as priority,
      c.sent_data ->> 'resolution_code' as resolution_code,
      c.sent_data ->> 'resolution_update' as resolution_update,
      c.sent_data ->> 'short_description' as short_description,
        nh.timestamp as history_timestamp,nh.status ,nh.tags_nr_vsad as vsad,nam.app_name,
        nh.category,nh.group_name,nh.user_name
        from datacollection.c_ops_ays_data c
      join datacollection.newrelic_vsad_event_history nh on c.incident_id = nh.root_inc_id
        and c.action = nh.status
      left join datacollection.nsit_apps_master nam on nh.tags_nr_vsad = nam.vsad)
      select RN,incident_id,coalesce(ays_group,group_name) as ays_group,ays_inc_number,user_name,ays_assigned_username,action, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,min(openTimeStamp) over ( partition by incident_id) as open_ays_timestamp,
      min(assignTimestamp) over ( partition by incident_id) as assign_ays_submission,
      max(closeTimeStamp) over ( partition by incident_id) as close_ays_submission,vsad,coalesce(app_name,vsad) as app_name,aysTime,
              case when category='' then 'Not Mapped'
                else category
                end

               from (
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,timestamp openTimeStamp,null::timestamp without time zone assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='OPEN_AYS'
      union
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,timestamp assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action in('ASSIGN_AYS','ASSIGN_GROUP','ASSIGN_TIER2','ESCALATE_TIER','CONVERT_TO_MIM')
      union
      select ROW_NUMBER() OVER (PARTITION BY incident_id
      ORDER BY timestamp DESC) AS RN, incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, 'Resolved' as state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,null::timestamp without time zone assignTimestamp, history_timestamp closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='CLOSE_AYS'

      ) as t)
      SELECT * from aysInfo where RN=1
      order by vsad,incident_id,aystime )
SELECT
    COUNT(DISTINCT ( ays_query."ays_inc_number"  ) ) AS "ays_query.incident_count"
FROM ays_query
WHERE (ays_query."action" ) = 'ESCALATE_TIER' AND ((CASE
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) >= 5) THEN 'Ack > 5'
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) < 5) THEN 'Ack < 5'
  ELSE 'Other'
END
) <> 'Other' OR (CASE
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) >= 5) THEN 'Ack > 5'
  WHEN (( (CAST(DATE_PART('hour', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)*60 + CAST(DATE_PART('minute', DATE_PART('epoch', (CAST((ays_query."assign_ays_submission") AS TIMESTAMP) - CAST((ays_query."open_ays_timestamp")  AS TIMESTAMP))) * INTERVAL '1 SECOND') AS BIGINT)) ) < 5) THEN 'Ack < 5'
  ELSE 'Other'
END
) IS NULL)
FETCH NEXT 1 ROWS ONLY


 Query Two:
   WITH ays_query AS (with aysInfo as(with ays as (
      select c.incident_id, c.action, c.timestamp, c.ays_assigned_username,
      c.response_data -> 'incident' ->> 'assignment_group' as ays_group,
      c.response_data -> 'incident' ->> 'number' as ays_inc_number,
      c.response_data -> 'incident' ->> 'state' as state,
      c.response_data -> 'incident' ->> 'caller_id' as caller_id,
      c.response_data -> 'incident' ->> 'affected_user' as affected_user,
      c.response_data -> 'incident' ->> 'configuration_item' as configuration_item,
      c.response_data -> 'incident' ->> 'priority' as priority,
      c.sent_data ->> 'resolution_code' as resolution_code,
      c.sent_data ->> 'resolution_update' as resolution_update,
      c.sent_data ->> 'short_description' as short_description,
        nh.timestamp as history_timestamp,nh.status ,nh.tags_nr_vsad as vsad,nam.app_name,
        nh.category,nh.group_name,nh.user_name
        from datacollection.c_ops_ays_data c
      join datacollection.newrelic_vsad_event_history nh on c.incident_id = nh.root_inc_id
        and c.action = nh.status
      left join datacollection.nsit_apps_master nam on nh.tags_nr_vsad = nam.vsad)
      select RN,incident_id,coalesce(ays_group,group_name) as ays_group,ays_inc_number,user_name,ays_assigned_username,action, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,min(openTimeStamp) over ( partition by incident_id) as open_ays_timestamp,
      min(assignTimestamp) over ( partition by incident_id) as assign_ays_submission,
      max(closeTimeStamp) over ( partition by incident_id) as close_ays_submission,vsad,coalesce(app_name,vsad) as app_name,aysTime,
              case when category='' then 'Not Mapped'
                else category
                end

               from (
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,timestamp openTimeStamp,null::timestamp without time zone assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='OPEN_AYS'
      union
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,timestamp assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action in('ASSIGN_AYS','ASSIGN_GROUP','ASSIGN_TIER2','ESCALATE_TIER','CONVERT_TO_MIM')
      union
      select ROW_NUMBER() OVER (PARTITION BY incident_id
      ORDER BY timestamp DESC) AS RN, incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, 'Resolved' as state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,null::timestamp without time zone assignTimestamp, history_timestamp closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='CLOSE_AYS'

      ) as t)
      SELECT * from aysInfo where RN=1
      order by vsad,incident_id,aystime )
SELECT
    ays_query."action"  AS "ays_query.action",
    COUNT(DISTINCT ( ays_query."ays_inc_number"  ) ) AS "ays_query.incident_count"
FROM ays_query
WHERE (ays_query."action" ) = 'ESCALATE_TIER'
GROUP BY
    1
ORDER BY
    2 DESC
FETCH NEXT 500 ROWS ONLY

-- sql for creating the total and/or determining pivot columns
WITH ays_query AS (with aysInfo as(with ays as (
      select c.incident_id, c.action, c.timestamp, c.ays_assigned_username,
      c.response_data -> 'incident' ->> 'assignment_group' as ays_group,
      c.response_data -> 'incident' ->> 'number' as ays_inc_number,
      c.response_data -> 'incident' ->> 'state' as state,
      c.response_data -> 'incident' ->> 'caller_id' as caller_id,
      c.response_data -> 'incident' ->> 'affected_user' as affected_user,
      c.response_data -> 'incident' ->> 'configuration_item' as configuration_item,
      c.response_data -> 'incident' ->> 'priority' as priority,
      c.sent_data ->> 'resolution_code' as resolution_code,
      c.sent_data ->> 'resolution_update' as resolution_update,
      c.sent_data ->> 'short_description' as short_description,
        nh.timestamp as history_timestamp,nh.status ,nh.tags_nr_vsad as vsad,nam.app_name,
        nh.category,nh.group_name,nh.user_name
        from datacollection.c_ops_ays_data c
      join datacollection.newrelic_vsad_event_history nh on c.incident_id = nh.root_inc_id
        and c.action = nh.status
      left join datacollection.nsit_apps_master nam on nh.tags_nr_vsad = nam.vsad)
      select RN,incident_id,coalesce(ays_group,group_name) as ays_group,ays_inc_number,user_name,ays_assigned_username,action, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,min(openTimeStamp) over ( partition by incident_id) as open_ays_timestamp,
      min(assignTimestamp) over ( partition by incident_id) as assign_ays_submission,
      max(closeTimeStamp) over ( partition by incident_id) as close_ays_submission,vsad,coalesce(app_name,vsad) as app_name,aysTime,
              case when category='' then 'Not Mapped'
                else category
                end

               from (
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,timestamp openTimeStamp,null::timestamp without time zone assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='OPEN_AYS'
      union
      select 1 RN,incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,timestamp assignTimestamp, null::timestamp without time zone closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action in('ASSIGN_AYS','ASSIGN_GROUP','ASSIGN_TIER2','ESCALATE_TIER','CONVERT_TO_MIM')
      union
      select ROW_NUMBER() OVER (PARTITION BY incident_id
      ORDER BY timestamp DESC) AS RN, incident_id,ays_group,ays_inc_number,user_name,ays_assigned_username, 'Resolved' as state,caller_id,affected_user,configuration_item,priority,resolution_code,
      resolution_update,short_description,null::timestamp without time zone openTimeStamp,null::timestamp without time zone assignTimestamp, history_timestamp closeTimeStamp,action,vsad,app_name,timestamp aysTime,coalesce(category,'') as category,group_name from ays
      where ays.action='CLOSE_AYS'

      ) as t)
      SELECT * from aysInfo where RN=1
      order by vsad,incident_id,aystime )
SELECT
    COUNT(DISTINCT ( ays_query."ays_inc_number"  ) ) AS "ays_query.incident_count"
FROM ays_query
WHERE (ays_query."action" ) = 'ESCALATE_TIER'
FETCH NEXT 1 ROWS ONLY
