WITH
  current_time_est AS (
    SELECT
      TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 10 MINUTE) AS current_time_est
  ),
  heartbeat_data AS (
    SELECT 
      DATE(StartTime) AS Logdate,
      COUNT(DISTINCT FORMAT_TIMESTAMP('%Y-%m-%d %H:%M', StartTime)) AS minute_count
    FROM 
      `vz-it-pr-jabv-aidplt-0.AIDSRE.TD_HEART_BEAT_INFO` 
    WHERE
      DATE(StartTime) <= DATE(current_time_est.current_time_est)
    GROUP BY  
      Logdate
  )

SELECT
  hd.Logdate,
  hd.minute_count,
  CASE
    WHEN hd.Logdate = DATE(current_time_est.current_time_est) THEN
      hd.minute_count / TIMESTAMP_DIFF(TIMESTAMP(current_time_est.current_time_est), TIMESTAMP(DATE(hd.Logdate)), MINUTE)
    ELSE
      hd.minute_count / 1440
  END AS Availability
FROM
  heartbeat_data hd
CROSS JOIN
  current_time_est
ORDER BY
  hd.Logdate DESC;