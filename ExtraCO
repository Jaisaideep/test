WITH current_time_est AS (
    SELECT
      timestamp_sub(timestamp(format_timestamp('%Y-%m-%d %H:%M:00', current_timestamp(), 'America/New_York')), INTERVAL 10 MINUTE) AS current_time_est
  ),
  heartbeat_data AS (
    SELECT 
      DATE(starttime) AS logdate,
      COUNT(DISTINCT format_timestamp('%Y-%m-%d %H:%M', starttime)) AS minute_count
    FROM 
      `vz-it-pr-jabv-aidplt-0.aidsre.td_heart_beat_info` 
    GROUP BY  
      logdate
  ),
  availability_calculation AS (
    SELECT
      hd.logdate,
      hd.minute_count,
      CASE
        WHEN hd.logdate = DATE(current_timestamp(), 'America/New_York') THEN
          hd.minute_count / TIMESTAMP_DIFF(current_time_est.current_time_est, timestamp(concat(format_date('%Y-%m-%d', hd.logdate), ' 00:00:00'), 'America/New_York'), MINUTE)
        ELSE
          hd.minute_count / 1440
      END AS availability
    FROM
      heartbeat_data hd
    CROSS JOIN
      current_time_est
  )

SELECT
  logdate,
  availability
FROM
  availability_calculation
ORDER BY
  logdate DESC;
