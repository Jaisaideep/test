WITH current_time_est AS (
    SELECT
      TIMESTAMP_SUB(TIMESTAMP(FORMAT_TIMESTAMP('%Y-%m-%d %H:%M:00', CURRENT_TIMESTAMP(), 'America/New_York')), INTERVAL 10 MINUTE) AS current_time_est
  ),
  heartbeat_data AS (
    SELECT 
      DATE(starttime) AS logdate,
      COUNT(DISTINCT FORMAT_TIMESTAMP('%Y-%m-%d %H:%M', starttime)) AS minute_count
    FROM 
      `vz-it-pr-jabv-aidplt-0.aidsre.td_heart_beat_info` 
    WHERE 
      DATE(starttime, 'America/New_York') = DATE(CURRENT_TIMESTAMP(), 'America/New_York')
    GROUP BY  
      logdate
  ),
  availability_calculation AS (
    SELECT
      hd.logdate,
      hd.minute_count,
      CASE
        WHEN hd.logdate = DATE(CURRENT_TIMESTAMP(), 'America/New_York') THEN
          hd.minute_count / TIMESTAMP_DIFF(current_time_est.current_time_est, TIMESTAMP(CONCAT(FORMAT_DATE('%Y-%m-%d', hd.logdate), ' 00:00:00'), 'America/New_York'), MINUTE)
        ELSE
          hd.minute_count / 1440.0  -- Assuming 1440 minutes in a day
      END AS availability
    FROM
      heartbeat_data hd
    CROSS JOIN
      current_time_est
  )

SELECT
  logdate,
  availability
FROM
  availability_calculation
ORDER BY
  logdate DESC;